;First memory manager that uses the free space in the lower Mbyte (see memory_map.txt)
;to reserve memory

;0x500 - 0x7bff
;

[global reserve_dword]
[global reserve_memory]

SPACE_POINTER	dd 0x00000500

reserve_dword:
.stage1:
	mov eax, dword [SPACE_POINTER]
	mov ebx, eax
	add ebx, 0x04
	mov dword [SPACE_POINTER], ebx
	cmp dword [SPACE_POINTER], 0x00007e00
	jl .stage2
	cmp dword [SPACE_POINTER], 0x0007ffff
	jl .end
	cmp dword [SPACE_POINTER], 0x00100000
	jl .stage3


;This function reserves a specified amount of memory in 4-byte blocks (DWORD)
reserve_memory:
	mov eax, dword [esp+4]		;Contains the requested amount of memory in bytes
	mov ecx, dword [SPACE_POINTER]
	add ecx, eax
	cmp ecx, 0x00007bff
	jl .reserve
	cmp ecx, 0x00007e00
	jl .stage1

.stage1:
	mov dword [SPACE_POINTER], 0x00

.reserve:
	mov ebx, eax
	div eax, 4
	mod ebx, 4
	cmp ebx, 0
	je .skip
	inc eax

.skip:
	

	
